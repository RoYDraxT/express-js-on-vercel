<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Fichas Técnicas - EcoModel</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/fichas-tecnicas.css" />
  </head>
  <body>
    <div class="container">
      <nav class="sidebar">
        <div class="logo-container">
          <div class="logo-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-leaf w-6 h-6 text-white" aria-hidden="true"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>
          </div>
          <div class="logo-text">
            <h2>EcoModel</h2>
            <span>Fintech Verde</span>
          </div>
        </div>
        <ul class="nav-menu">
          <li><a href="/" class="nav-link"><svg class="icon icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg> Panel Principal</a></li>
          <li><a href="/fichas-tecnicas" class="nav-link active"><svg class="icon icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg> Fichas Técnicas</a></li>
          <li><a href="/evaluacion-credito" class="nav-link"><svg class="icon icon-doc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Evaluación de Crédito</a></li>
          
          <li class="nav-subtitle">HERRAMIENTAS</li>
          <li><a href="/gestion-cartera" class="nav-link"><svg class="icon icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg> Gestión de Cartera</a></li>
          <li><a href="/analiticas" class="nav-link"><svg class="icon icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 5H9.5a1.5 1.5 0 00-1.5 1.5v12a1.5 1.5 0 001.5 1.5H17"/></svg> Analíticas</a></li>
          
          <li class="nav-subtitle">INTELIGENCIA</li>
          <li><a href="/eco-asesor" class="nav-link"><svg class="icon icon-ai" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 110 6 3 3 0 010-6zm0 9a3 3 0 110 6 3 3 0 010-6zm6-7a3 3 0 110 6 3 3 0 010-6zm-12 0a3 3 0 110 6 3 3 0 010-6z"/></svg> Eco-Asesor IA</a></li>
        </ul>
      </nav>
      
      <main class="content">
        <h1>Fichas Técnicas</h1>
        <p>Genera fichas técnicas para diferentes cultivos y analiza su viabilidad financiera</p>
        
        <!-- Formulario de entrada HORIZONTAL -->
        <div class="formulario-horizontal">
          <div class="form-row">
            <div class="form-item">
              <label for="categoria">Categoría</label>
              <select id="categoria">
                <option value="">Selecciona una categoría</option>
              </select>
            </div>

            <div class="form-item">
              <label for="cultivo">Cultivo</label>
              <select id="cultivo" disabled>
                <option value="">Selecciona una categoría primero</option>
              </select>
            </div>

            <div class="form-item">
              <label for="hectareas">Hectáreas</label>
              <input 
                type="number" 
                id="hectareas" 
                min="0.1" 
                step="0.1" 
                value="1.0" 
              />
            </div>

            <button class="btn-calcular" onclick="calcularFichaTecnica()">
              Calcular
            </button>
          </div>

          <div class="error-mensaje" id="mensajeError"></div>
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Calculando ficha técnica...</div>
          </div>
        </div>

        <!-- 4 SECTORES OCULTOS -->
        <div class="sectores-container">
          <!-- Sector 1: Parámetros -->
          <div class="sector oculto" id="sector-parametros" data-ficha-id="">
            <h3>Parámetros</h3>
            <div class="sector-contenido">
              <!-- Será llenado con JavaScript -->
            </div>
          </div>

          <!-- Sector 2: Producción -->
          <div class="sector oculto" id="sector-produccion" data-ficha-id="">
            <h3>Producción</h3>
            <div class="sector-contenido">
              <!-- Será llenado con JavaScript -->
            </div>
          </div>

          <!-- Sector 3: Costos de Producción -->
          <div class="sector oculto" id="sector-costos-produccion" data-ficha-id="">
            <h3>Costos de Producción</h3>
            <div class="sector-contenido">
              <!-- Será llenado con JavaScript -->
            </div>
          </div>

          <!-- Sector 4: Costos de Instalación -->
          <div class="sector oculto" id="sector-costos-instalacion" data-ficha-id="">
            <h3>Costos de Instalación</h3>
            <div class="sector-contenido">
              <!-- Será llenado con JavaScript -->
            </div>
          </div>
        </div>
      </main>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Cargar categorías al iniciar
      async function cargarCategorias() {
        try {
          const response = await fetch('/api/categorias');
          const categorias = await response.json();
          const select = document.getElementById('categoria');

          categorias.forEach((cat) => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.nombre;
            select.appendChild(option);
          });

          if (categorias.length > 0) {
            select.value = categorias[0].id;
          }
        } catch (error) {
          console.error('Error cargando categorías:', error);
        }
      }

      // Agrega esto después de cargarCategorias()
      async function cargarCultivosPorCategoria(categoriaId) {
        const cultivoSelect = document.getElementById('cultivo');
        cultivoSelect.innerHTML = '<option value="">Cargando...</option>';
        cultivoSelect.disabled = true;

        try {
          const response = await fetch(`/api/cultivos/${categoriaId}`);
          const cultivos = await response.json();
          
          cultivoSelect.innerHTML = '<option value="">Selecciona un cultivo</option>';
          cultivos.forEach(cultivo => {
            const option = document.createElement('option');
            option.value = cultivo.id;
            option.textContent = cultivo.nombre;
            cultivoSelect.appendChild(option);
          });
          
          cultivoSelect.disabled = false;
        } catch (error) {
          console.error('Error cargando cultivos:', error);
          cultivoSelect.innerHTML = '<option value="">Error al cargar</option>';
        }
      }

      // Agrega evento al select de categoría
      document.getElementById('categoria').addEventListener('change', function() {
        const categoriaId = this.value;
        if (categoriaId) {
          cargarCultivosPorCategoria(categoriaId);
        } else {
          document.getElementById('cultivo').innerHTML = '<option value="">Selecciona una categoría primero</option>';
          document.getElementById('cultivo').disabled = true;
        }
      });

      document.addEventListener('DOMContentLoaded', cargarCategorias);

      async function calcularFichaTecnica() {
        const hectareas = parseFloat(document.getElementById('hectareas').value);
        const cultivo_id = document.getElementById('cultivo').value; // Ahora usamos cultivo_id
        const btnCalcular = document.querySelector('.btn-calcular');
        const loading = document.getElementById('loading');
        const mensajeError = document.getElementById('mensajeError');

        if (isNaN(hectareas) || hectareas <= 0) {
          mensajeError.textContent = 'Ingresa un número válido de hectáreas mayor a 0';
          mensajeError.classList.add('activo');
          return;
        }

        if (!cultivo_id) {
          mensajeError.textContent = 'Selecciona un cultivo';
          mensajeError.classList.add('activo');
          return;
        }

        mensajeError.classList.remove('activo');
        loading.classList.add('activo');
        btnCalcular.disabled = true;

        try {
          // Cambia la URL a la nueva API
          const response = await fetch('/api/ficha-tecnica-cacao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hectareas, cultivo_id: parseInt(cultivo_id) })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Error desconocido');
          }

          mostrarSectores(data);
        } catch (error) {
          mensajeError.textContent = 'Error: ' + error.message;
          mensajeError.classList.add('activo');
          console.error(error);
        } finally {
          loading.classList.remove('activo');
          btnCalcular.disabled = false;
        }
      }

      function mostrarSectores(ficha) {
        const fichaId = ficha.id_ficha || 'temp-' + Date.now();
        const datos = ficha.datos_proyecto;
        const analisis = ficha.analisis_financiero;
        const produccion = ficha.produccion_promedio;

        // Sector 1: Parámetros
        llenarSector('sector-parametros', fichaId, [
          { label: 'Hectáreas', valor: datos.hectareas },
          { label: 'Variedad', valor: datos.variedad },
          { label: 'Ciclo Productivo', valor: datos.ciclo_productivo_años + ' años' }
        ]);

        // Sector 2: Producción
        llenarSector('sector-produccion', fichaId, [
          { label: 'Producción (qq)', valor: produccion.produccion_qq, clase: 'valor-cantidad' },
          { label: 'Ingresos', valor: '$' + formatNumber(produccion.ingresos), clase: 'valor-dinero' }
        ]);

        // Sector 3: Costos de Producción
        llenarSector('sector-costos-produccion', fichaId, [
          { label: 'Costos', valor: '$' + formatNumber(produccion.costos), clase: 'valor-dinero' },
          { label: 'Utilidad', valor: '$' + formatNumber(produccion.utilidad), clase: 'valor-dinero' }
        ]);

        // Sector 4: Costos de Instalación
        llenarSector('sector-costos-instalacion', fichaId, [
          { label: 'Costo Total', valor: '$' + formatNumber(ficha.instalacion.costo_total), clase: 'valor-dinero' },
          { label: 'Costo por Hectárea', valor: '$' + formatNumber(ficha.instalacion.costo_por_hectarea), clase: 'valor-dinero' }
        ]);

        // Hacer visibles todos los sectores
        document.querySelectorAll('.sector').forEach(sector => {
          sector.classList.remove('oculto');
          sector.classList.add('visible');
          sector.dataset.fichaId = fichaId;
        });
      }

      function llenarSector(sectorId, fichaId, datos) {
        const sector = document.getElementById(sectorId);
        const contenido = sector.querySelector('.sector-contenido');
        
        contenido.innerHTML = datos.map(d => `
          <div class="dato-fila">
            <div class="dato-label">${d.label}</div>
            <div class="dato-valor ${d.clase || ''}">
              ${d.valor}
            </div>
          </div>
        `).join('');
      }

      function formatNumber(num) {
        return new Intl.NumberFormat('es-CO', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(num);
      }

      document.getElementById('hectareas').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          calcularFichaTecnica();
        }
      });
    </script>
  </body>
</html>