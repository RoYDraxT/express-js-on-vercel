<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Fichas Técnicas - EcoModel</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/fichas-tecnicas.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="container">
      <nav class="sidebar">
        <div class="logo-container">
          <div class="logo-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-leaf w-6 h-6 text-white" aria-hidden="true"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>
          </div>
          <div class="logo-text">
            <h2>EcoModel</h2>
            <span>Fintech Verde</span>
          </div>
        </div>
        <ul class="nav-menu">
          <li><a href="/" class="nav-link"><svg class="icon icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg> Panel Principal</a></li>
          <li><a href="/fichas-tecnicas" class="nav-link active"><svg class="icon icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg> Fichas Técnicas</a></li>
          <li><a href="/evaluacion-credito" class="nav-link"><svg class="icon icon-doc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Evaluación de Crédito</a></li>
          
          <li class="nav-subtitle">HERRAMIENTAS</li>
          <li><a href="/gestion-cartera" class="nav-link"><svg class="icon icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg> Gestión de Cartera</a></li>
          <li><a href="/analiticas" class="nav-link"><svg class="icon icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 5H9.5a1.5 1.5 0 00-1.5 1.5v12a1.5 1.5 0 001.5 1.5H17"/></svg> Analíticas</a></li>
          
          <li class="nav-subtitle">INTELIGENCIA</li>
          <li><a href="/eco-asesor" class="nav-link"><svg class="icon icon-ai" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 110 6 3 3 0 010-6zm0 9a3 3 0 110 6 3 3 0 010-6zm6-7a3 3 0 110 6 3 3 0 010-6zm-12 0a3 3 0 110 6 3 3 0 010-6z"/></svg> Eco-Asesor IA</a></li>
        </ul>
      </nav>
      
      <main class="content">
        <h1>Fichas Técnicas</h1>
        <p>Genera fichas técnicas para diferentes cultivos y analiza su viabilidad financiera</p>
        
        <!-- Formulario de entrada HORIZONTAL -->
        <div class="formulario-horizontal">
          <div class="form-row">
            <div class="form-item">
              <label for="categoria">Categoría</label>
              <select id="categoria">
                <option value="">Selecciona una categoría</option>
              </select>
            </div>

            <div class="form-item">
              <label for="cultivo">Cultivo</label>
              <select id="cultivo">
                <option value="">Selecciona un cultivo</option>
              </select>
            </div>

            <div class="form-item">
              <label for="hectareas">Hectáreas</label>
              <input 
                type="number" 
                id="hectareas" 
                min="0.1" 
                step="0.1" 
                value="1.0" 
              />
            </div>

            <button class="btn-calcular" onclick="calcularFichaTecnica()">
              Calcular
            </button>
          </div>

          <div class="error-mensaje" id="mensajeError"></div>
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Calculando ficha técnica...</div>
          </div>
          
          <!-- Botón de comparación (aparece después de calcular) -->
          <div class="comparacion-container" id="comparacionContainer" style="display: none;">
            <button class="btn-comparar" onclick="mostrarComparacion()">
              Ver Comparación Sensibilizado vs No Sensibilizado
            </button>
          </div>
        </div>

        <!-- 4 SECTORES OCULTOS -->
        <div class="sectores-container">
          <!-- Sector 1: DASHBOARD PARAMETROS Y PRODUCCIÓN -->
          <div class="sector oculto" id="sector-parametros" data-ficha-id="">
            <h3>Parámetros y Producción - Cacao Convencional</h3>
            
            <div class="dashboard-container">
              <!-- Columna Izquierda: Información General -->
              <div class="dashboard-col info-general">
                <div class="info-section">
                  <h4>INFORMACIÓN GENERAL</h4>
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="info-label">Frecuencia de Venta:</span>
                      <span class="info-value" id="frecuencia-venta">Por Campaña</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Ciclo Productivo:</span>
                      <span class="info-value" id="ciclo-productivo">1 vez al año (1 Siembra = 1 Cosecha)</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Tipo de Producción:</span>
                      <span class="info-value" id="tipo-produccion">Campo abierto</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Fuente de Riego:</span>
                      <span class="info-value" id="fuente-riego">Canales de riego y de lluvias</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Periodo Vegetativo:</span>
                      <span class="info-value" id="periodo-vegetativo">15 Años</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Periodo Post Cosecha:</span>
                      <span class="info-value" id="periodo-postcosecha">1 mes</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Distanciamiento:</span>
                      <span class="info-value" id="distanciamiento">3.0m x 3.0m</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Meses Mantenimiento:</span>
                      <span class="info-value" id="meses-mantenimiento">Dic/Ene - Abr/Jul</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Meses Comercialización:</span>
                      <span class="info-value" id="meses-comercializacion">Abr/Jul</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Variedad:</span>
                      <span class="info-value" id="variedad">CCN 51 (Híbrido)</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Provincias:</span>
                      <span class="info-value" id="provincias">La Convención, Calca</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Forma Comercialización:</span>
                      <span class="info-value" id="forma-comercializacion">Grano seco</span>
                    </div>
                  </div>
                </div>
                
                <div class="info-section extensión-section">
                  <div class="extension-box">
                    <span class="extension-label">EXTENSIÓN (HAS)</span>
                    <span class="extension-value" id="extension-has">1.00</span>
                  </div>
                </div>
              </div>

              <!-- Columna Centro: Productividad y Parámetros -->
              <div class="dashboard-col productividad-col">
                <!-- Tabla de Productividad -->
                <div class="tabla-productividad">
                  <h4>PRODUCTIVIDAD POR AÑOS</h4>
                  <table class="tabla-prod">
                    <thead>
                      <tr>
                        <th>Período</th>
                        <th>QQ</th>
                        <th>Rendim</th>
                        <th>1RA</th>
                        <th>2DA</th>
                        <th>3RA</th>
                      </tr>
                    </thead>
                    <tbody id="tabla-productividad-body">
                      <!-- Se llenará dinámicamente -->
                    </tbody>
                  </table>
                </div>

                <!-- Parámetros Productivos -->
                <div class="parametros-productivos">
                  <h4>PARÁMETROS PRODUCTIVOS</h4>
                  <div class="param-grid">
                    <div class="param-item">
                      <span class="param-label">Número Total de Plantones:</span>
                      <span class="param-value" id="num-plantones">1,111</span>
                    </div>
                    <div class="param-item">
                      <span class="param-label">Producción por Árbol (QQ/año):</span>
                      <span class="param-value" id="prod-arbol">0.03</span>
                    </div>
                    <div class="param-item">
                      <span class="param-label">Merma Productiva:</span>
                      <span class="param-value" id="merma-productiva">2%</span>
                    </div>
                    <div class="param-item destacado">
                      <span class="param-label">Producción Total Anual (QQ):</span>
                      <span class="param-value" id="prod-total-anual">26.2</span>
                    </div>
                  </div>
                </div>

                <!-- Producto Cosechado -->
                <div class="producto-cosechado">
                  <h4>PRODUCTO COSECHADO</h4>
                  <table class="tabla-cosecha">
                    <thead>
                      <tr>
                        <th>Calidad</th>
                        <th>Rendimiento (QQ)</th>
                        <th>Precio Venta (S/.)</th>
                      </tr>
                    </thead>
                    <tbody id="tabla-cosecha-body">
                      <!-- Se llenará dinámicamente -->
                    </tbody>
                    <tfoot>
                      <tr class="total-row">
                        <td><strong>Promedio</strong></td>
                        <td id="rendimiento-promedio"><strong>26.2</strong></td>
                        <td id="precio-promedio"><strong>440.00</strong></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- Columna Derecha: Gráfico y Costos -->
              <div class="dashboard-col grafico-col">
                <!-- Gráfico Evolutivo -->
                <div class="grafico-container">
                  <h4>Evolutivo de Costos y Ventas (S/.)</h4>
                  <canvas id="graficoEvolutivo"></canvas>
                  <div class="leyenda-grafico">
                    <div class="leyenda-item">
                      <span class="leyenda-color" style="background: #ef4444;"></span>
                      <span>Costos Programados (Sensibilizado)</span>
                    </div>
                    <div class="leyenda-item">
                      <span class="leyenda-color" style="background: #22c55e;"></span>
                      <span>Ventas Programadas</span>
                    </div>
                  </div>
                  <div class="nota-sensibilizado">
                    <p class="nota-verde">La columna verde engloba el total de ganancia de Abr/Jul</p>
                  </div>
                </div>

                <!-- Costos Sensibilizados/No Sensibilizados -->
                <div class="costos-sensibilizados">
                  <div class="costos-header">
                    <h4 id="costos-titulo">COSTOS SENSIBILIZADOS</h4>
                    <div class="costos-toggle">
                      <span class="costos-opcion" id="costosNoSensibilizado">No Sens.</span>
                      <label class="toggle-switch">
                        <input type="checkbox" id="sensibilizado" checked onchange="cambiarModoSensibilizado()">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="costos-opcion" id="costosSensibilizado">Sens.</span>
                    </div>
                  </div>
                  <div class="costos-grid">
                    <div class="costo-item">
                      <span class="costo-label">Costo Técnico:</span>
                      <span class="costo-value" id="costo-tecnico">S/. 5,551</span>
                    </div>
                    <div class="costo-item">
                      <span class="costo-label">Ingreso Bruto de la Venta:</span>
                      <span class="costo-value" id="ingreso-bruto">S/. 11,514</span>
                    </div>
                    <div class="costo-item">
                      <span class="costo-label">Costos Asumidos por Productor:</span>
                      <span class="costo-value" id="costos-asumidos">S/. 680</span>
                    </div>
                    <div class="costo-item" id="costo-item-principal">
                      <span class="costo-label">Costos Sensibilizados:</span>
                      <span class="costo-value destaca" id="costos-sensibilizados">S/. 4,871</span>
                    </div>
                    <div class="costo-item">
                      <span class="costo-label">Utilidad Sensibilizada:</span>
                      <span class="costo-value utilidad" id="utilidad-sensibilizada">S/. 6,644</span>
                    </div>
                    <div class="costo-item">
                      <span class="costo-label">Costo de Prod. Sensibilizado:</span>
                      <span class="costo-value porcentaje" id="costo-prod-porcentaje">42.30%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sector 2: Producción (DEPRECADO - ahora integrado en Parámetros) -->
          <div class="sector oculto" id="sector-produccion" data-ficha-id="" style="display: none;">
            <h3>Producción</h3>
            <div class="sector-contenido">
              <!-- Será llenado con JavaScript -->
            </div>
          </div>

          <!-- Sector 3: Costos de Producción Detallado -->
          <div class="sector oculto" id="sector-costos-produccion" data-ficha-id="">
            <div class="sector-header-with-info">
              <h3>Detalle del Costo de Producción y Cronograma de Ejecución</h3>
              <div class="info-icon-wrapper">
                <span class="info-icon" id="info-costos-btn">ℹ</span>
                <div class="info-tooltip" id="info-costos-tooltip">
                  <p><strong>COSTO TOTAL:</strong> Costo total por hectárea</p>
                  <p><strong>PRECIO UNITARIO:</strong> Precio de la unidad de medida</p>
                  <p><strong>CANTIDAD POR HAS:</strong> Cantidad de unidades por hectárea</p>
                  <p><strong>UD MEDIDA:</strong> Unidad de medida (Jornal, Día, Saco, Litro, etc.)</p>
                  <p style="margin-top: 10px;"><strong>Meses (Ago-Jul):</strong> Distribución mensual del costo</p>
                </div>
              </div>
            </div>
            
            <div class="costos-produccion-container">
              <!-- Tabla Principal de Costos -->
              <div class="tabla-costos-wrapper">
                <table class="tabla-costos-produccion">
                  <thead>
                    <tr>
                      <th class="concepto-header">Concepto</th>
                      <th class="precio-header">Costo Total</th>
                      <th class="precio-unitario-header">Precio Unit.</th>
                      <th class="cantidad-header">Cant./Has</th>
                      <th class="unidad-header">UD Medida</th>
                      <th>Ago</th>
                      <th>Sep</th>
                      <th>Oct</th>
                      <th>Nov</th>
                      <th>Dic</th>
                      <th>Ene</th>
                      <th>Feb</th>
                      <th>Mar</th>
                      <th>Abr</th>
                      <th>May</th>
                      <th>Jun</th>
                      <th>Jul</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody id="tabla-costos-directos">
                    <!-- Se llenará dinámicamente -->
                  </tbody>
                  <tfoot>
                    <tr class="total-directos-row">
                      <td colspan="5"><strong>TOTAL COSTO DIRECTO</strong></td>
                      <td id="total-ago">257</td>
                      <td id="total-sep">693</td>
                      <td id="total-oct">1,156</td>
                      <td id="total-nov">1,037</td>
                      <td id="total-dic">188</td>
                      <td id="total-ene">506</td>
                      <td id="total-feb">120</td>
                      <td id="total-mar">188</td>
                      <td id="total-abr">240</td>
                      <td id="total-may">1,120</td>
                      <td id="total-jun">-</td>
                      <td id="total-jul">-</td>
                      <td id="total-directo"><strong>5,236</strong></td>
                    </tr>
                  </tfoot>
                </table>
                
                <!-- Costos Indirectos -->
                <table class="tabla-costos-indirectos">
                  <thead>
                    <tr>
                      <th class="concepto-header">Concepto</th>
                      <th class="precio-header">Costo Total</th>
                      <th class="precio-unitario-header">Porcentaje</th>
                      <th>Ago</th>
                      <th>Sep</th>
                      <th>Oct</th>
                      <th>Nov</th>
                      <th>Dic</th>
                      <th>Ene</th>
                      <th>Feb</th>
                      <th>Mar</th>
                      <th>Abr</th>
                      <th>May</th>
                      <th>Jun</th>
                      <th>Jul</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody id="tabla-costos-indirectos">
                    <!-- Se llenará dinámicamente -->
                  </tbody>
                  <tfoot>
                    <tr class="total-indirectos-row">
                      <td colspan="3"><strong>TOTAL COSTO INDIRECTO</strong></td>
                      <td id="total-ind-ago">-</td>
                      <td id="total-ind-sep">-</td>
                      <td id="total-ind-oct">-</td>
                      <td id="total-ind-nov">-</td>
                      <td id="total-ind-dic">-</td>
                      <td id="total-ind-ene">-</td>
                      <td id="total-ind-feb">-</td>
                      <td id="total-ind-mar">-</td>
                      <td id="total-ind-abr">-</td>
                      <td id="total-ind-may">-</td>
                      <td id="total-ind-jun">-</td>
                      <td id="total-ind-jul">-</td>
                      <td id="total-indirecto"><strong>314</strong></td>
                    </tr>
                  </tfoot>
                </table>

                <!-- Resumen mensual (Directos + Indirectos) -->
                <table class="tabla-resumen-costos">
                  <thead>
                    <tr>
                      <th class="concepto-header">Resumen</th>
                      <th>Ago</th>
                      <th>Sep</th>
                      <th>Oct</th>
                      <th>Nov</th>
                      <th>Dic</th>
                      <th>Ene</th>
                      <th>Feb</th>
                      <th>Mar</th>
                      <th>Abr</th>
                      <th>May</th>
                      <th>Jun</th>
                      <th>Jul</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="resumen-directos-row">
                      <td><strong>TOTAL COSTOS DIRECTOS</strong></td>
                      <td id="res-dir-ago">-</td>
                      <td id="res-dir-sep">-</td>
                      <td id="res-dir-oct">-</td>
                      <td id="res-dir-nov">-</td>
                      <td id="res-dir-dic">-</td>
                      <td id="res-dir-ene">-</td>
                      <td id="res-dir-feb">-</td>
                      <td id="res-dir-mar">-</td>
                      <td id="res-dir-abr">-</td>
                      <td id="res-dir-may">-</td>
                      <td id="res-dir-jun">-</td>
                      <td id="res-dir-jul">-</td>
                      <td id="res-dir-total"><strong>-</strong></td>
                    </tr>
                    <tr class="resumen-indirectos-row">
                      <td><strong>TOTAL COSTOS INDIRECTOS</strong></td>
                      <td id="res-ind-ago">-</td>
                      <td id="res-ind-sep">-</td>
                      <td id="res-ind-oct">-</td>
                      <td id="res-ind-nov">-</td>
                      <td id="res-ind-dic">-</td>
                      <td id="res-ind-ene">-</td>
                      <td id="res-ind-feb">-</td>
                      <td id="res-ind-mar">-</td>
                      <td id="res-ind-abr">-</td>
                      <td id="res-ind-may">-</td>
                      <td id="res-ind-jun">-</td>
                      <td id="res-ind-jul">-</td>
                      <td id="res-ind-total"><strong>-</strong></td>
                    </tr>
                    <tr class="resumen-total-row">
                      <td><strong>TOTAL COSTOS (DIRECTOS + INDIRECTOS)</strong></td>
                      <td id="res-tot-ago">-</td>
                      <td id="res-tot-sep">-</td>
                      <td id="res-tot-oct">-</td>
                      <td id="res-tot-nov">-</td>
                      <td id="res-tot-dic">-</td>
                      <td id="res-tot-ene">-</td>
                      <td id="res-tot-feb">-</td>
                      <td id="res-tot-mar">-</td>
                      <td id="res-tot-abr">-</td>
                      <td id="res-tot-may">-</td>
                      <td id="res-tot-jun">-</td>
                      <td id="res-tot-jul">-</td>
                      <td id="res-tot-total"><strong>-</strong></td>
                    </tr>
                    <tr class="resumen-gastos-row">
                      <td><strong>GASTOS ASUMIDOS POR PRODUCTOR</strong></td>
                      <td id="res-gas-ago">-</td>
                      <td id="res-gas-sep">-</td>
                      <td id="res-gas-oct">-</td>
                      <td id="res-gas-nov">-</td>
                      <td id="res-gas-dic">-</td>
                      <td id="res-gas-ene">-</td>
                      <td id="res-gas-feb">-</td>
                      <td id="res-gas-mar">-</td>
                      <td id="res-gas-abr">-</td>
                      <td id="res-gas-may">-</td>
                      <td id="res-gas-jun">-</td>
                      <td id="res-gas-jul">-</td>
                      <td id="res-gas-total"><strong>-</strong></td>
                    </tr>
                  </tbody>
                </table>
                
                <!-- Resumen Final -->
                <div class="resumen-costos">
                  <div class="resumen-item">
                    <span class="resumen-label">TOTAL COSTOS DE PRODUCCIÓN (I + II):</span>
                    <span class="resumen-value" id="total-costos-produccion">S/. 5,551</span>
                  </div>
                  <div class="resumen-item">
                    <span class="resumen-label">GASTOS ASUMIDOS POR PRODUCTOR:</span>
                    <span class="resumen-value" id="gastos-asumidos-productor">S/. 680</span>
                  </div>
                  <div class="resumen-item destacado">
                    <span class="resumen-label">COSTOS PROGRAMADOS (Sensibilizado):</span>
                    <span class="resumen-value" id="costos-programados-sensibilizado">S/. 4,871</span>
                  </div>
                  <div class="resumen-item ingresos">
                    <span class="resumen-label">VENTAS PROGRAMADAS:</span>
                    <span class="resumen-value" id="ventas-programadas">S/. 11,514</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sector 4: Costos de Instalación -->
          <div class="sector oculto" id="sector-costos-instalacion" data-ficha-id="">
            <div class="sector-header-with-info">
              <h3>Detalle del Costo de Instalación y Cronograma de Ejecución (1 Año)</h3>
              <div class="info-icon-wrapper">
                <span class="info-icon" id="info-instalacion-btn">ℹ</span>
                <div class="info-tooltip" id="info-instalacion-tooltip">
                  <p><strong>COSTO TOTAL:</strong> Costo total por hectárea</p>
                  <p><strong>PRECIO UNITARIO:</strong> Precio de la unidad de medida</p>
                  <p><strong>CANTIDAD POR HAS:</strong> Cantidad de unidades por hectárea</p>
                  <p><strong>UD MEDIDA:</strong> Unidad de medida (Jornal, Día, Saco, Litro, etc.)</p>
                  <p style="margin-top: 10px;"><strong>Meses (Ago-Jul):</strong> Distribución mensual del costo</p>
                </div>
              </div>
            </div>

            <div class="costos-produccion-container">
              <div class="tabla-costos-wrapper">
                <table class="tabla-costos-produccion">
                  <thead>
                    <tr>
                      <th class="concepto-header">Concepto</th>
                      <th class="precio-header">Costo Total</th>
                      <th class="precio-unitario-header">Precio Unit.</th>
                      <th class="cantidad-header">Cant./Has</th>
                      <th class="unidad-header">UD Medida</th>
                      <th>Ago</th>
                      <th>Sep</th>
                      <th>Oct</th>
                      <th>Nov</th>
                      <th>Dic</th>
                      <th>Ene</th>
                      <th>Feb</th>
                      <th>Mar</th>
                      <th>Abr</th>
                      <th>May</th>
                      <th>Jun</th>
                      <th>Jul</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody id="tabla-costos-instalacion-directos">
                    <!-- Se llenará dinámicamente -->
                  </tbody>
                  <tfoot>
                    <tr class="total-directos-row">
                      <td colspan="5"><strong>TOTAL COSTO DIRECTO</strong></td>
                      <td id="inst-total-ago">-</td>
                      <td id="inst-total-sep">-</td>
                      <td id="inst-total-oct">-</td>
                      <td id="inst-total-nov">-</td>
                      <td id="inst-total-dic">-</td>
                      <td id="inst-total-ene">-</td>
                      <td id="inst-total-feb">-</td>
                      <td id="inst-total-mar">-</td>
                      <td id="inst-total-abr">-</td>
                      <td id="inst-total-may">-</td>
                      <td id="inst-total-jun">-</td>
                      <td id="inst-total-jul">-</td>
                      <td id="inst-total-directo"><strong>-</strong></td>
                    </tr>
                  </tfoot>
                </table>

                <table class="tabla-costos-indirectos">
                  <thead>
                    <tr>
                      <th class="concepto-header">Concepto</th>
                      <th class="precio-header">Costo Total</th>
                      <th class="precio-unitario-header">Porcentaje</th>
                      <th>Ago</th>
                      <th>Sep</th>
                      <th>Oct</th>
                      <th>Nov</th>
                      <th>Dic</th>
                      <th>Ene</th>
                      <th>Feb</th>
                      <th>Mar</th>
                      <th>Abr</th>
                      <th>May</th>
                      <th>Jun</th>
                      <th>Jul</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody id="tabla-costos-instalacion-indirectos">
                    <!-- Se llenará dinámicamente -->
                  </tbody>
                  <tfoot>
                    <tr class="total-indirectos-row">
                      <td colspan="3"><strong>TOTAL COSTO INDIRECTO</strong></td>
                      <td id="inst-total-ind-ago">-</td>
                      <td id="inst-total-ind-sep">-</td>
                      <td id="inst-total-ind-oct">-</td>
                      <td id="inst-total-ind-nov">-</td>
                      <td id="inst-total-ind-dic">-</td>
                      <td id="inst-total-ind-ene">-</td>
                      <td id="inst-total-ind-feb">-</td>
                      <td id="inst-total-ind-mar">-</td>
                      <td id="inst-total-ind-abr">-</td>
                      <td id="inst-total-ind-may">-</td>
                      <td id="inst-total-ind-jun">-</td>
                      <td id="inst-total-ind-jul">-</td>
                      <td id="inst-total-indirecto"><strong>-</strong></td>
                    </tr>
                  </tfoot>
                </table>

                <table class="tabla-resumen-costos">
                  <thead>
                    <tr>
                      <th class="concepto-header">Resumen</th>
                      <th>Ago</th>
                      <th>Sep</th>
                      <th>Oct</th>
                      <th>Nov</th>
                      <th>Dic</th>
                      <th>Ene</th>
                      <th>Feb</th>
                      <th>Mar</th>
                      <th>Abr</th>
                      <th>May</th>
                      <th>Jun</th>
                      <th>Jul</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="resumen-total-row">
                      <td><strong>TOTAL COSTOS DIRECTOS</strong></td>
                      <td id="inst-res-dir-ago">-</td>
                      <td id="inst-res-dir-sep">-</td>
                      <td id="inst-res-dir-oct">-</td>
                      <td id="inst-res-dir-nov">-</td>
                      <td id="inst-res-dir-dic">-</td>
                      <td id="inst-res-dir-ene">-</td>
                      <td id="inst-res-dir-feb">-</td>
                      <td id="inst-res-dir-mar">-</td>
                      <td id="inst-res-dir-abr">-</td>
                      <td id="inst-res-dir-may">-</td>
                      <td id="inst-res-dir-jun">-</td>
                      <td id="inst-res-dir-jul">-</td>
                      <td id="inst-res-dir-total"><strong>-</strong></td>
                    </tr>
                    <tr class="resumen-gastos-row">
                      <td><strong>TOTAL COSTOS INDIRECTOS</strong></td>
                      <td id="inst-res-ind-ago">-</td>
                      <td id="inst-res-ind-sep">-</td>
                      <td id="inst-res-ind-oct">-</td>
                      <td id="inst-res-ind-nov">-</td>
                      <td id="inst-res-ind-dic">-</td>
                      <td id="inst-res-ind-ene">-</td>
                      <td id="inst-res-ind-feb">-</td>
                      <td id="inst-res-ind-mar">-</td>
                      <td id="inst-res-ind-abr">-</td>
                      <td id="inst-res-ind-may">-</td>
                      <td id="inst-res-ind-jun">-</td>
                      <td id="inst-res-ind-jul">-</td>
                      <td id="inst-res-ind-total"><strong>-</strong></td>
                    </tr>
                    <tr class="resumen-total-row">
                      <td><strong>TOTAL COSTOS (DIRECTOS + INDIRECTOS)</strong></td>
                      <td id="inst-res-tot-ago">-</td>
                      <td id="inst-res-tot-sep">-</td>
                      <td id="inst-res-tot-oct">-</td>
                      <td id="inst-res-tot-nov">-</td>
                      <td id="inst-res-tot-dic">-</td>
                      <td id="inst-res-tot-ene">-</td>
                      <td id="inst-res-tot-feb">-</td>
                      <td id="inst-res-tot-mar">-</td>
                      <td id="inst-res-tot-abr">-</td>
                      <td id="inst-res-tot-may">-</td>
                      <td id="inst-res-tot-jun">-</td>
                      <td id="inst-res-tot-jul">-</td>
                      <td id="inst-res-tot-total"><strong>-</strong></td>
                    </tr>
                    <tr class="resumen-gastos-row">
                      <td><strong>GASTOS ASUMIDOS POR PRODUCTOR</strong></td>
                      <td id="inst-res-gas-ago">-</td>
                      <td id="inst-res-gas-sep">-</td>
                      <td id="inst-res-gas-oct">-</td>
                      <td id="inst-res-gas-nov">-</td>
                      <td id="inst-res-gas-dic">-</td>
                      <td id="inst-res-gas-ene">-</td>
                      <td id="inst-res-gas-feb">-</td>
                      <td id="inst-res-gas-mar">-</td>
                      <td id="inst-res-gas-abr">-</td>
                      <td id="inst-res-gas-may">-</td>
                      <td id="inst-res-gas-jun">-</td>
                      <td id="inst-res-gas-jul">-</td>
                      <td id="inst-res-gas-total"><strong>-</strong></td>
                    </tr>
                  </tbody>
                </table>

                <div class="resumen-costos">
                  <div class="resumen-item">
                    <span class="resumen-label">TOTAL COSTOS DE INSTALACIÓN (I + II):</span>
                    <span class="resumen-value" id="total-costos-instalacion">S/. -</span>
                  </div>
                  <div class="resumen-item">
                    <span class="resumen-label">GASTOS ASUMIDOS POR PRODUCTOR:</span>
                    <span class="resumen-value" id="gastos-asumidos-instalacion">S/. -</span>
                  </div>
                  <div class="resumen-item destacado">
                    <span class="resumen-label">COSTO TOTAL SENSIBILIZADO:</span>
                    <span class="resumen-value" id="costo-total-sensibilizado-instalacion">S/. -</span>
                  </div>
                  <div class="resumen-item">
                    <span class="resumen-label">VAN (10%):</span>
                    <span class="resumen-value" id="van-instalacion">S/. -</span>
                  </div>
                  <div class="resumen-item">
                    <span class="resumen-label">TIR:</span>
                    <span class="resumen-value" id="tir-instalacion">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      let allCultivos = [];
      let allCategorias = [];
      let ultimaFicha = null; // Guardar la última ficha calculada      let datosOriginalesDashboard = null; // Para guardar los datos originales del dashboard
      let ultimoResumenCostos = null;
      // Cargar categorías al iniciar
      async function cargarCategorias() {
        try {
          const response = await fetch('/api/categorias');
          allCategorias = await response.json();
          const select = document.getElementById('categoria');

          allCategorias.forEach((cat) => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.nombre;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error cargando categorías:', error);
        }
      }

      // Cargar todos los cultivos
      async function cargarCultivos() {
        try {
          const response = await fetch('/api/todos-cultivos');
          allCultivos = await response.json();
          const cultivoSelect = document.getElementById('cultivo');
          
          allCultivos.forEach(cultivo => {
            const option = document.createElement('option');
            option.value = cultivo.id;
            option.textContent = cultivo.nombre;
            option.dataset.categoriaId = cultivo.categoria_id;
            cultivoSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Error cargando cultivos:', error);
        }
      }

      // Cuando se elige un cultivo, auto-rellenar categoría
      document.addEventListener('DOMContentLoaded', () => {
        cargarCategorias();
        cargarCultivos();
        
        document.getElementById('cultivo').addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const categoriaId = selectedOption.dataset.categoriaId;
          
          if (categoriaId) {
            document.getElementById('categoria').value = categoriaId;
          }
        });

        // Cuando se elige categoría, filtrar cultivos
        document.getElementById('categoria').addEventListener('change', function() {
          const categoriaId = this.value;
          const cultivoSelect = document.getElementById('cultivo');
          
          if (categoriaId) {
            const opcionesCultivo = cultivoSelect.querySelectorAll('option');
            opcionesCultivo.forEach(opt => {
              if (opt.value === '') {
                opt.style.display = 'block';
              } else if (opt.dataset.categoriaId === categoriaId) {
                opt.style.display = 'block';
              } else {
                opt.style.display = 'none';
              }
            });
            cultivoSelect.value = '';
          }
        });
      });

      function cambiarModoSensibilizado() {
        if (!ultimaFicha || !datosOriginalesDashboard) return;
        
        const sensibilizado = document.getElementById('sensibilizado').checked;
        const costosTitulo = document.getElementById('costos-titulo');
        const costosNoSensibilizadoSpan = document.getElementById('costosNoSensibilizado');
        const costosSensibilizadoSpan = document.getElementById('costosSensibilizado');
        
        // Actualizar título del cuadro
        costosTitulo.textContent = sensibilizado ? 'COSTOS SENSIBILIZADOS' : 'COSTOS NO SENSIBILIZADOS';
        
        // Actualizar estilos de las opciones del toggle
        if (sensibilizado) {
          costosSensibilizadoSpan.classList.add('activo');
          costosNoSensibilizadoSpan.classList.remove('activo');
        } else {
          costosNoSensibilizadoSpan.classList.add('activo');
          costosSensibilizadoSpan.classList.remove('activo');
        }
        
        // Obtener los datos alternativos para costos
        const datosAMostrar = sensibilizado 
          ? ultimaFicha.calculos_alternativos.sensibilizado 
          : ultimaFicha.calculos_alternativos.no_sensibilizado;
        
        // Actualizar SOLO el cuadro de costos
        actualizarCuadroCostos(datosAMostrar, sensibilizado, ultimoResumenCostos);
        
        // Actualizar tabla de costos de producción detallado
        llenarTablaCostosProduccion(ultimaFicha, sensibilizado);
      }
      
      function actualizarCuadroCostos(ficha, sensibilizado, resumenCostos = null) {
        const ingresoAnual = (ficha.produccion_promedio && ficha.produccion_promedio.ingresos !== undefined)
          ? ficha.produccion_promedio.ingresos
          : (resumenCostos && resumenCostos.ingresoAnual ? resumenCostos.ingresoAnual : 0);
        const totalCostosProduccion = (resumenCostos && resumenCostos.totalCostosProduccion !== undefined)
          ? resumenCostos.totalCostosProduccion
          : (ficha.produccion_promedio && ficha.produccion_promedio.costos ? ficha.produccion_promedio.costos : 0);

        const hectareasFicha = (ficha.datos_proyecto && ficha.datos_proyecto.hectareas) ? ficha.datos_proyecto.hectareas : 1;
        const gastosAsumidos = (resumenCostos && resumenCostos.gastosAsumidos !== undefined)
          ? resumenCostos.gastosAsumidos
          : ((ficha.costos_produccion_detallado && ficha.costos_produccion_detallado.gastos_asumidos_productor)
            ? ficha.costos_produccion_detallado.gastos_asumidos_productor
            : 680.00 * hectareasFicha);

        const costosNetos = sensibilizado ? (totalCostosProduccion - gastosAsumidos) : totalCostosProduccion;
        const utilidad = ingresoAnual - costosNetos;
        const costoProdPorcentaje = ingresoAnual > 0 ? (costosNetos / ingresoAnual * 100).toFixed(2) : '0.00';
        
        // Actualizar valores del cuadro de costos
        document.getElementById('costo-tecnico').textContent = 'S/. ' + formatNumber(totalCostosProduccion.toFixed(2));
        const ingresoBrutoElem = document.getElementById('ingreso-bruto');
        if (ingresoBrutoElem) {
          ingresoBrutoElem.textContent = 'S/. ' + formatNumber(ingresoAnual.toFixed(2));
        }
        document.getElementById('costos-asumidos').textContent = 'S/. ' + formatNumber(gastosAsumidos.toFixed(2));
        document.getElementById('costos-sensibilizados').textContent = 'S/. ' + formatNumber(costosNetos.toFixed(2));
        document.getElementById('utilidad-sensibilizada').textContent = 'S/. ' + formatNumber(utilidad.toFixed(2));
        document.getElementById('costo-prod-porcentaje').textContent = costoProdPorcentaje + '%';
        
        // Cambiar labels según el modo
        const costoItemPrincipal = document.getElementById('costo-item-principal');
        const labelPrincipal = costoItemPrincipal.querySelector('.costo-label');
        labelPrincipal.textContent = sensibilizado ? 'Costos Sensibilizados:' : 'Costos No Sensibilizados:';

        const utilidadItem = document.getElementById('utilidad-sensibilizada');
        const utilidadLabel = utilidadItem ? utilidadItem.closest('.costo-item')?.querySelector('.costo-label') : null;
        if (utilidadLabel) {
          utilidadLabel.textContent = sensibilizado ? 'Utilidad Sensibilizada:' : 'Utilidad No Sensibilizada:';
        }

        const porcentajeItem = document.getElementById('costo-prod-porcentaje');
        const porcentajeLabel = porcentajeItem ? porcentajeItem.closest('.costo-item')?.querySelector('.costo-label') : null;
        if (porcentajeLabel) {
          porcentajeLabel.textContent = sensibilizado ? 'Costo de Prod. Sensibilizado:' : 'Costo de Prod. No Sensibilizado:';
        }
        
      }
      
      // Esta función ya no se usa porque solo el cuadro de costos cambia
      // Se mantiene por compatibilidad pero no hace mucho

      async function calcularFichaTecnica() {
        const hectareas = parseFloat(document.getElementById('hectareas').value);
        const categoria_id = document.getElementById('categoria').value;
        const cultivo_id = document.getElementById('cultivo').value;
        const sensibilizado = document.getElementById('sensibilizado').checked;
        const btnCalcular = document.querySelector('.btn-calcular');
        const loading = document.getElementById('loading');
        const mensajeError = document.getElementById('mensajeError');

        if (isNaN(hectareas) || hectareas <= 0) {
          mensajeError.textContent = 'Ingresa un número válido de hectáreas mayor a 0';
          mensajeError.classList.add('activo');
          return;
        }

        if (!cultivo_id) {
          mensajeError.textContent = 'Selecciona un cultivo';
          mensajeError.classList.add('activo');
          return;
        }

        // Validar que sea PEREN_SEMI y cacao (convencional)
        if (categoria_id !== 'PEREN_SEMI') {
          mensajeError.textContent = 'Aún no se ha registrado dicha ficha técnica.';
          mensajeError.classList.add('activo');
          return;
        }

        const cultivoOption = document.getElementById('cultivo').options[document.getElementById('cultivo').selectedIndex];
        const cultivoNombre = cultivoOption.textContent.toLowerCase();
        
        if (!cultivoNombre.includes('cacao') || !cultivoNombre.includes('convencional')) {
          mensajeError.textContent = 'Aún no se ha registrado dicha ficha técnica.';
          mensajeError.classList.add('activo');
          return;
        }

        mensajeError.classList.remove('activo');
        loading.classList.add('activo');
        btnCalcular.disabled = true;

        try {
          const response = await fetch('/api/ficha-tecnica-cacao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hectareas, categoria_id, cultivo_id: parseInt(cultivo_id), sensibilizado })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Error desconocido');
          }

          // Guardar la ficha para poder cambiar el modo después
          ultimaFicha = data;
          datosOriginalesDashboard = {
            produccion_promedio: data.produccion_promedio,
            datos_proyecto: data.datos_proyecto
          };
          mostrarSectores(data);
          
          // Mostrar los sectores
          mostrarSectores(data);
          
          // Actualizar el toggle de costos
          const toggleCheckbox = document.getElementById('sensibilizado');
          toggleCheckbox.checked = data.modo_sensibilizado;
          
        } catch (error) {
          mensajeError.textContent = 'Error: ' + error.message;
          mensajeError.classList.add('activo');
          console.error(error);
        } finally {
          loading.classList.remove('activo');
          btnCalcular.disabled = false;
        }
      }

      function llenarTablaCostosProduccion(ficha, sensibilizado) {
        if (!ficha.costos_produccion_detallado) return;
        
        const costos = ficha.costos_produccion_detallado;
        const hectareas = ficha.datos_proyecto.hectareas;
        const meses = ['ago', 'sep', 'oct', 'nov', 'dic', 'ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul'];
        
        // Tabla de costos directos con subcategorías
        const tablaCostosDirectos = document.getElementById('tabla-costos-directos');
        let htmlDirectos = '';
        let totalesPorMes = { ago: 0, sep: 0, oct: 0, nov: 0, dic: 0, ene: 0, feb: 0, mar: 0, abr: 0, may: 0, jun: 0, jul: 0 };
        let totalDirectoGlobal = 0;
        
        // Generar filas por categoría
        costos.costos_directos.forEach((categoria, catIdx) => {
          // Fila de categoría header
          const subtotalCategoria = categoria.subtotal;
          totalDirectoGlobal += subtotalCategoria;
          
          htmlDirectos += `<tr class="categoria-header-row" style="background-color: #fff59e;">
            <td colspan="5"><strong>${categoria.categoria}</strong></td>
            <td colspan="13"></td>
          </tr>`;
          
          // Filas de items
          categoria.items.forEach((item, itemIdx) => {
            const costoTotal = item.costo_total;
            let fila = `<tr class="item-row">
              <td>${item.nombre}</td>
              <td>${formatNumber(costoTotal)}</td>
              <td>${formatNumber(item.precio_unitario)}</td>
              <td>${item.cantidad.toFixed(2)}</td>
              <td>${item.ud}</td>`;
            
            meses.forEach(mes => {
              const costoMes = (item.meses[mes] || 0);
              totalesPorMes[mes] += costoMes;
              fila += `<td>${costoMes > 0 ? formatNumber(costoMes) : '-'}</td>`;
            });
            
            fila += `<td>${formatNumber(costoTotal)}</td></tr>`;
            htmlDirectos += fila;
          });
          
          // Fila de subtotal por categoría
          let subtotalMeses = { ago: 0, sep: 0, oct: 0, nov: 0, dic: 0, ene: 0, feb: 0, mar: 0, abr: 0, may: 0, jun: 0, jul: 0 };
          categoria.items.forEach(item => {
            meses.forEach(mes => {
              subtotalMeses[mes] += (item.meses[mes] || 0);
            });
          });
          
          htmlDirectos += `<tr class="espacio-blanco"><td colspan="18"></td></tr>`;
        });
        
        tablaCostosDirectos.innerHTML = htmlDirectos;
        
        // Actualizar totales del pie de tabla
        meses.forEach(mes => {
          const elem = document.getElementById(`total-${mes}`);
          if (elem) {
            elem.textContent = totalesPorMes[mes] > 0 ? formatNumber(totalesPorMes[mes]) : '-';
          }
        });
        document.getElementById('total-directo').innerHTML = '<strong>' + formatNumber(totalDirectoGlobal) + '</strong>';
        
        // Tabla de costos indirectos
        const tablaCostosIndirectos = document.getElementById('tabla-costos-indirectos');
        let htmlIndirectos = '';
        let totalIndirectoGlobal = 0;
        let totalesIndirectosPorMes = { ago: 0, sep: 0, oct: 0, nov: 0, dic: 0, ene: 0, feb: 0, mar: 0, abr: 0, may: 0, jun: 0, jul: 0 };
        
        costos.costos_indirectos.forEach(item => {
          const costoIndirecto = item.costo;
          totalIndirectoGlobal += costoIndirecto;
          
          let fila = `<tr class="item-row">
            <td>${item.nombre}</td>
            <td>${formatNumber(costoIndirecto)}</td>
            <td>${item.porcentaje.toFixed(2)}%</td>`;
          
          meses.forEach(mes => {
            const costoMes = (item.meses && item.meses[mes]) ? item.meses[mes] : 0;
            totalesIndirectosPorMes[mes] += costoMes;
            fila += `<td>${costoMes > 0 ? formatNumber(costoMes) : '-'}</td>`;
          });
          
          fila += `<td>${formatNumber(costoIndirecto)}</td></tr>`;
          htmlIndirectos += fila;
        });
        
        tablaCostosIndirectos.innerHTML = htmlIndirectos;
        meses.forEach(mes => {
          const elem = document.getElementById(`total-ind-${mes}`);
          if (elem) {
            elem.textContent = totalesIndirectosPorMes[mes] > 0 ? formatNumber(totalesIndirectosPorMes[mes]) : '-';
          }
        });
        document.getElementById('total-indirecto').innerHTML = '<strong>' + formatNumber(totalIndirectoGlobal) + '</strong>';

        // Resumen mensual: directos, indirectos y total
        meses.forEach(mes => {
          const valDir = totalesPorMes[mes] || 0;
          const valInd = totalesIndirectosPorMes[mes] || 0;
          const valTot = valDir + valInd;

          const elemDir = document.getElementById(`res-dir-${mes}`);
          if (elemDir) {
            elemDir.textContent = valDir > 0 ? formatNumber(valDir) : '-';
          }

          const elemInd = document.getElementById(`res-ind-${mes}`);
          if (elemInd) {
            elemInd.textContent = valInd > 0 ? formatNumber(valInd) : '-';
          }

          const elemTot = document.getElementById(`res-tot-${mes}`);
          if (elemTot) {
            elemTot.textContent = valTot > 0 ? formatNumber(valTot) : '-';
          }
        });

        const totalGlobal = totalDirectoGlobal + totalIndirectoGlobal;
        const resDirTotal = document.getElementById('res-dir-total');
        if (resDirTotal) {
          resDirTotal.innerHTML = '<strong>' + formatNumber(totalDirectoGlobal) + '</strong>';
        }
        const resIndTotal = document.getElementById('res-ind-total');
        if (resIndTotal) {
          resIndTotal.innerHTML = '<strong>' + formatNumber(totalIndirectoGlobal) + '</strong>';
        }
        const resTotTotal = document.getElementById('res-tot-total');
        if (resTotTotal) {
          resTotTotal.innerHTML = '<strong>' + formatNumber(totalGlobal) + '</strong>';
        }

        // Gastos asumidos por productor (suma de subcategorías específicas)
        const gastosAsumidosMeses = { ago: 0, sep: 0, oct: 0, nov: 0, dic: 0, ene: 0, feb: 0, mar: 0, abr: 0, may: 0, jun: 0, jul: 0 };
        const nombresGastosAsumidos = [
          'plantones de reposición de sombra',
          'abonamiento y/o fertilización',
          'fumigados',
          'fungicida',
          'insecticida',
          'herbicida',
          'secado',
          'ensacado',
          'envasado'
        ];

        const matchGastoAsumido = (nombre) => {
          const nombreNormalizado = nombre.toLowerCase();
          return nombresGastosAsumidos.some(ref => nombreNormalizado.includes(ref));
        };

        let totalGastosAsumidos = 0;
        costos.costos_directos.forEach(categoria => {
          categoria.items.forEach(item => {
            if (matchGastoAsumido(item.nombre)) {
              totalGastosAsumidos += item.costo_total || 0;
              meses.forEach(mes => {
                gastosAsumidosMeses[mes] += (item.meses && item.meses[mes]) ? item.meses[mes] : 0;
              });
            }
          });
        });

        // Ajustar al total de gastos asumidos si está definido en la ficha
        const gastosAsumidosMeta = (costos.gastos_asumidos_productor !== undefined)
          ? costos.gastos_asumidos_productor
          : null;
        if (gastosAsumidosMeta !== null && totalGastosAsumidos > 0 && Math.abs(totalGastosAsumidos - gastosAsumidosMeta) > 0.01) {
          const factor = gastosAsumidosMeta / totalGastosAsumidos;
          totalGastosAsumidos = gastosAsumidosMeta;
          meses.forEach(mes => {
            gastosAsumidosMeses[mes] = gastosAsumidosMeses[mes] * factor;
          });
        }

        meses.forEach(mes => {
          const elemGas = document.getElementById(`res-gas-${mes}`);
          if (elemGas) {
            elemGas.textContent = gastosAsumidosMeses[mes] > 0 ? formatNumber(gastosAsumidosMeses[mes]) : '-';
          }
        });
        const resGasTotal = document.getElementById('res-gas-total');
        if (resGasTotal) {
          resGasTotal.innerHTML = '<strong>' + formatNumber(totalGastosAsumidos) + '</strong>';
        }

        // Actualizar gráfico con costos mensuales reales
        const costosMensualesBase = meses.map(mes => (totalesPorMes[mes] || 0) + (totalesIndirectosPorMes[mes] || 0));
        const costosMensuales = costosMensualesBase.map((val, idx) => {
          const mesKey = meses[idx];
          const ajuste = sensibilizado ? (gastosAsumidosMeses[mesKey] || 0) : 0;
          return Math.max(val - ajuste, 0);
        });
        const ingresoAnualGrafico = (ficha.produccion_promedio && ficha.produccion_promedio.ingresos)
          ? ficha.produccion_promedio.ingresos
          : 0;
        crearGraficoEvolutivo(costosMensuales, ingresoAnualGrafico);
        
        // Actualizar resumen
        const totalCostosProduccion = totalDirectoGlobal + totalIndirectoGlobal;
        const gastosAsumidos = (costos.gastos_asumidos_productor !== undefined)
          ? costos.gastos_asumidos_productor
          : 680.00 * hectareas;
        const costosSensibilizados = (totalCostosProduccion - gastosAsumidos);
        const ingresosMensuales = (ficha.produccion_promedio.ingresos || 11514);
        
        document.getElementById('total-costos-produccion').textContent = 'S/. ' + formatNumber(totalCostosProduccion);
        document.getElementById('gastos-asumidos-productor').textContent = 'S/. ' + formatNumber(gastosAsumidos);
        document.getElementById('costos-programados-sensibilizado').textContent = 'S/. ' + formatNumber(costosSensibilizados);
        document.getElementById('ventas-programadas').textContent = 'S/. ' + formatNumber(ingresosMensuales);

        // Guardar resumen para el cuadro de costos del sector 1
        ultimoResumenCostos = {
          totalCostosProduccion,
          gastosAsumidos,
          ingresoAnual: ingresosMensuales
        };
        actualizarCuadroCostos(ficha, sensibilizado, ultimoResumenCostos);
      }

      function llenarTablaCostosInstalacion(ficha, sensibilizado) {
        if (!ficha.costos_instalacion_detallado) return;

        const costos = ficha.costos_instalacion_detallado;
        const meses = ['ago', 'sep', 'oct', 'nov', 'dic', 'ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul'];

        // Tabla de costos directos
        const tablaDirectos = document.getElementById('tabla-costos-instalacion-directos');
        let htmlDirectos = '';
        let totalesPorMes = { ago: 0, sep: 0, oct: 0, nov: 0, dic: 0, ene: 0, feb: 0, mar: 0, abr: 0, may: 0, jun: 0, jul: 0 };
        let totalDirectoGlobal = 0;

        costos.costos_directos.forEach(categoria => {
          const subtotalCategoria = categoria.subtotal || 0;
          totalDirectoGlobal += subtotalCategoria;

          htmlDirectos += `<tr class="categoria-header-row" style="background-color: #fff59e;">
            <td colspan="5"><strong>${categoria.categoria}</strong></td>
            <td colspan="13"></td>
          </tr>`;

          categoria.items.forEach(item => {
            const costoTotal = item.costo_total || 0;
            let fila = `<tr class="item-row">
              <td>${item.nombre}</td>
              <td>${formatNumber(costoTotal)}</td>
              <td>${formatNumber(item.precio_unitario)}</td>
              <td>${item.cantidad.toFixed(2)}</td>
              <td>${item.ud}</td>`;

            meses.forEach(mes => {
              const costoMes = (item.meses && item.meses[mes]) ? item.meses[mes] : 0;
              totalesPorMes[mes] += costoMes;
              fila += `<td>${costoMes > 0 ? formatNumber(costoMes) : '-'}</td>`;
            });

            fila += `<td>${formatNumber(costoTotal)}</td></tr>`;
            htmlDirectos += fila;
          });

          htmlDirectos += `<tr class="espacio-blanco"><td colspan="18"></td></tr>`;
        });

        if (tablaDirectos) {
          tablaDirectos.innerHTML = htmlDirectos;
        }

        meses.forEach(mes => {
          const elem = document.getElementById(`inst-total-${mes}`);
          if (elem) {
            elem.textContent = totalesPorMes[mes] > 0 ? formatNumber(totalesPorMes[mes]) : '-';
          }
        });
        const totalDirectoElem = document.getElementById('inst-total-directo');
        if (totalDirectoElem) {
          totalDirectoElem.innerHTML = '<strong>' + formatNumber(totalDirectoGlobal) + '</strong>';
        }

        // Tabla de costos indirectos
        const tablaIndirectos = document.getElementById('tabla-costos-instalacion-indirectos');
        let htmlIndirectos = '';
        let totalIndirectoGlobal = 0;
        let totalesIndirectosPorMes = { ago: 0, sep: 0, oct: 0, nov: 0, dic: 0, ene: 0, feb: 0, mar: 0, abr: 0, may: 0, jun: 0, jul: 0 };

        costos.costos_indirectos.forEach(item => {
          const costoIndirecto = item.costo || 0;
          totalIndirectoGlobal += costoIndirecto;

          let fila = `<tr class="item-row">
            <td>${item.nombre}</td>
            <td>${formatNumber(costoIndirecto)}</td>
            <td>${item.porcentaje.toFixed(2)}%</td>`;

          meses.forEach(mes => {
            const costoMes = (item.meses && item.meses[mes]) ? item.meses[mes] : 0;
            totalesIndirectosPorMes[mes] += costoMes;
            fila += `<td>${costoMes > 0 ? formatNumber(costoMes) : '-'}</td>`;
          });

          fila += `<td>${formatNumber(costoIndirecto)}</td></tr>`;
          htmlIndirectos += fila;
        });

        if (tablaIndirectos) {
          tablaIndirectos.innerHTML = htmlIndirectos;
        }
        meses.forEach(mes => {
          const elem = document.getElementById(`inst-total-ind-${mes}`);
          if (elem) {
            elem.textContent = totalesIndirectosPorMes[mes] > 0 ? formatNumber(totalesIndirectosPorMes[mes]) : '-';
          }
        });
        const totalIndirectoElem = document.getElementById('inst-total-indirecto');
        if (totalIndirectoElem) {
          totalIndirectoElem.innerHTML = '<strong>' + formatNumber(totalIndirectoGlobal) + '</strong>';
        }

        // Resumen instalación
        const totalInstalacion = totalDirectoGlobal + totalIndirectoGlobal;
        const gastosAsumidos = (costos.gastos_asumidos_productor !== undefined) ? costos.gastos_asumidos_productor : 0;
        const costoSensibilizado = (costos.costo_total_sensibilizado !== undefined)
          ? costos.costo_total_sensibilizado
          : Math.max(totalInstalacion - gastosAsumidos, 0);

        // Resumen mensual (directos, indirectos, total, gastos asumidos)
        const gastosAsumidosMeses = costos.gastos_asumidos_meses || {};
        meses.forEach(mes => {
          const valDir = totalesPorMes[mes] || 0;
          const valInd = totalesIndirectosPorMes[mes] || 0;
          const valTot = valDir + valInd;
          const valGas = gastosAsumidosMeses[mes] || 0;

          const elemDir = document.getElementById(`inst-res-dir-${mes}`);
          if (elemDir) {
            elemDir.textContent = valDir > 0 ? formatNumber(valDir) : '-';
          }

          const elemInd = document.getElementById(`inst-res-ind-${mes}`);
          if (elemInd) {
            elemInd.textContent = valInd > 0 ? formatNumber(valInd) : '-';
          }

          const elemTot = document.getElementById(`inst-res-tot-${mes}`);
          if (elemTot) {
            elemTot.textContent = valTot > 0 ? formatNumber(valTot) : '-';
          }

          const elemGas = document.getElementById(`inst-res-gas-${mes}`);
          if (elemGas) {
            elemGas.textContent = valGas > 0 ? formatNumber(valGas) : '-';
          }
        });

        const resDirTotal = document.getElementById('inst-res-dir-total');
        if (resDirTotal) {
          resDirTotal.innerHTML = '<strong>' + formatNumber(totalDirectoGlobal) + '</strong>';
        }
        const resIndTotal = document.getElementById('inst-res-ind-total');
        if (resIndTotal) {
          resIndTotal.innerHTML = '<strong>' + formatNumber(totalIndirectoGlobal) + '</strong>';
        }
        const resTotTotal = document.getElementById('inst-res-tot-total');
        if (resTotTotal) {
          resTotTotal.innerHTML = '<strong>' + formatNumber(totalInstalacion) + '</strong>';
        }
        const resGasTotal = document.getElementById('inst-res-gas-total');
        if (resGasTotal) {
          resGasTotal.innerHTML = '<strong>' + formatNumber(gastosAsumidos) + '</strong>';
        }

        const totalInstalacionElem = document.getElementById('total-costos-instalacion');
        if (totalInstalacionElem) {
          totalInstalacionElem.textContent = 'S/. ' + formatNumber(totalInstalacion);
        }
        const gastosAsumidosElem = document.getElementById('gastos-asumidos-instalacion');
        if (gastosAsumidosElem) {
          gastosAsumidosElem.textContent = 'S/. ' + formatNumber(gastosAsumidos);
        }
        const costoSensElem = document.getElementById('costo-total-sensibilizado-instalacion');
        if (costoSensElem) {
          costoSensElem.textContent = 'S/. ' + formatNumber(costoSensibilizado);
        }

        const analisis = ficha.analisis_financiero || {};
        const vanElem = document.getElementById('van-instalacion');
        if (vanElem) {
          vanElem.textContent = 'S/. ' + formatNumber(analisis.van_tasa_10_pct || 0);
        }
        const tirElem = document.getElementById('tir-instalacion');
        if (tirElem) {
          tirElem.textContent = (analisis.tir_porcentaje !== undefined ? analisis.tir_porcentaje : 0) + '%';
        }
      }

      function mostrarSectores(ficha) {
        const fichaId = ficha.id_ficha || 'temp-' + Date.now();
        const datos = ficha.datos_proyecto;
        const analisis = ficha.analisis_financiero;
        const produccion = ficha.produccion_promedio;
        const instalacion = ficha.instalacion;
        const modoSensibilizado = ficha.modo_sensibilizado;

        // ========= SECTOR 1: DASHBOARD PARÁMETROS Y PRODUCCIÓN =========
        llenarDashboardParametros(datos, produccion, analisis, modoSensibilizado);

        // ========= SECTOR 2: COSTOS DE PRODUCCIÓN DETALLADO =========
        llenarTablaCostosProduccion(ficha, modoSensibilizado);

        // ========= SECTOR 4: COSTOS DE INSTALACIÓN DETALLADO =========
        llenarTablaCostosInstalacion(ficha, modoSensibilizado);

        // Hacer visibles todos los sectores
        document.querySelectorAll('.sector').forEach(sector => {
          if (sector.id !== 'sector-produccion') { // Omitir el sector de producción deprecado
            sector.classList.remove('oculto');
            sector.classList.add('visible');
            sector.dataset.fichaId = fichaId;
          }
        });
        
        // Inicializar el toggle de costos
        const toggleCheckbox = document.getElementById('sensibilizado');
        const costosSensibilizadoSpan = document.getElementById('costosSensibilizado');
        const costosNoSensibilizadoSpan = document.getElementById('costosNoSensibilizado');
        
        if (modoSensibilizado) {
          costosSensibilizadoSpan.classList.add('activo');
          costosNoSensibilizadoSpan.classList.remove('activo');
        } else {
          costosNoSensibilizadoSpan.classList.add('activo');
          costosSensibilizadoSpan.classList.remove('activo');
        }
      }

      function llenarDashboardParametros(datos, produccion, analisis, modoSensibilizado) {
        // Información General
        document.getElementById('extension-has').textContent = datos.hectareas.toFixed(2);
        document.getElementById('periodo-vegetativo').textContent = datos.ciclo_productivo_años + ' Años (Incluye ' + datos.años_desarrollo + ' años de desarrollo)';
        document.getElementById('variedad').textContent = datos.variedad;
        document.getElementById('provincias').textContent = datos.region;
        
        // Tabla de Productividad
        const tablaProductividad = document.getElementById('tabla-productividad-body');
        const productividad = [
          { periodo: '1er-3er año', qq: 0, rendim: '0%', primera: '0%', segunda: '0%', tercera: '0%' },
          { periodo: '4to-6to año', qq: 24.0, rendim: '80%', primera: '90%', segunda: '10%', tercera: '0%' },
          { periodo: '7mo-9no año', qq: 27.0, rendim: '90%', primera: '90%', segunda: '10%', tercera: '0%' },
          { periodo: '10mo-11vo año', qq: 30.0, rendim: '100%', primera: '95%', segunda: '5%', tercera: '0%' },
          { periodo: '12vo-13vo año', qq: 28.5, rendim: '95%', primera: '80%', segunda: '20%', tercera: '0%' },
          { periodo: '14vo-15vo año', qq: 24.0, rendim: '80%', primera: '75%', segunda: '25%', tercera: '0%' }
        ];
        
        let htmlProductividad = '';
        productividad.forEach((p, idx) => {
          const rowClass = idx === 0 ? 'desarrollo-row' : '';
          htmlProductividad += `
            <tr class="${rowClass}">
              <td>${p.periodo}</td>
              <td>${p.qq}</td>
              <td>${p.rendim}</td>
              <td>${p.primera}</td>
              <td>${p.segunda}</td>
              <td>${p.tercera}</td>
            </tr>
          `;
        });
        
        // Fila de promedios
        htmlProductividad += `
          <tr class="promedio-row">
            <td><strong>PROMEDIOS</strong></td>
            <td><strong>26.7</strong></td>
            <td><strong>89%</strong></td>
            <td><strong>86%</strong></td>
            <td><strong>14%</strong></td>
            <td><strong>0%</strong></td>
          </tr>
        `;
        
        tablaProductividad.innerHTML = htmlProductividad;
        
        // Parámetros Productivos
        const numPlantones = (datos.hectareas * 1111).toFixed(0);
        document.getElementById('num-plantones').textContent = formatNumber(numPlantones);
        document.getElementById('prod-arbol').textContent = '0.03';
        document.getElementById('merma-productiva').textContent = '2%';
        document.getElementById('prod-total-anual').textContent = produccion.produccion_qq_por_ha ? produccion.produccion_qq_por_ha.toFixed(1) : '26.2';
        
        // Producto Cosechado
        const tablaCosecha = document.getElementById('tabla-cosecha-body');
        const productosCosechados = [
          { calidad: '1RA', rendimiento: 22.5 * datos.hectareas, precio: 480.00 },
          { calidad: '2DA', rendimiento: 3.7 * datos.hectareas, precio: 400.00 }
        ];
        
        let htmlCosecha = '';
        productosCosechados.forEach(p => {
          htmlCosecha += `
            <tr>
              <td>${p.calidad}</td>
              <td>${p.rendimiento.toFixed(1)}</td>
              <td>${formatNumber(p.precio)}</td>
            </tr>
          `;
        });
        tablaCosecha.innerHTML = htmlCosecha;
        
        document.getElementById('rendimiento-promedio').innerHTML = '<strong>' + (produccion.produccion_qq || 26.2).toFixed(1) + '</strong>';
        document.getElementById('precio-promedio').innerHTML = '<strong>' + formatNumber(produccion.precio_venta_qq || 440) + '</strong>';
        
        // ===== COSTOS SENSIBILIZADOS =====
        // IMPORTANTE: Estos valores YA ESTÁN sensibilizados en los datos y NO cambian con el toggle
        // Solo varían si se recalcula con diferentes hectáreas
        
        const ingresoAnual = produccion.ingresos || 11514;
        const costoAnual = produccion.costos || 5551;
        const utilidadAnual = produccion.utilidad || 6644;
        
        // Estos son los valores fijos sensibilizados que NO cambiarán con el toggle
        const costoTecnico = 5550.50; // Ya sensibilizado
        const costosAsumidos = 680.00; // Valor fijo
        const costosSensibilizados = costoTecnico - costosAsumidos; // 4,871
        const utilidadSensibilizada = utilidadAnual; // Ya sensibilizada
        const costoProdPorcentaje = (costosSensibilizados / ingresoAnual * 100).toFixed(2);
        
        // Mostrar los valores FIJOS de costos sensibilizados (NO cambian con el toggle)
        document.getElementById('costo-tecnico').textContent = 'S/. ' + formatNumber(costoTecnico.toFixed(2));
        document.getElementById('costos-asumidos').textContent = 'S/. ' + formatNumber(costosAsumidos.toFixed(2));
        document.getElementById('costos-sensibilizados').textContent = 'S/. ' + formatNumber(costosSensibilizados.toFixed(2));
        document.getElementById('utilidad-sensibilizada').textContent = 'S/. ' + formatNumber(utilidadSensibilizada.toFixed(2));
        document.getElementById('costo-prod-porcentaje').textContent = costoProdPorcentaje + '%';
        
        // El gráfico se actualiza desde la tabla de costos
      }

      let chartEvolutivo = null;
      function crearGraficoEvolutivo(costosMensuales, ingresoAnual) {
        const ctx = document.getElementById('graficoEvolutivo');
        if (!ctx) return;
        
        // Destruir gráfico anterior si existe
        if (chartEvolutivo) {
          chartEvolutivo.destroy();
        }
        
        // Datos mensuales
        const meses = ['Ago', 'Sep', 'Oct', 'Nov', 'Dic', 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul'];
        
        // Costos mensuales calculados
        const costos = (Array.isArray(costosMensuales) && costosMensuales.length === 12)
          ? costosMensuales
          : new Array(12).fill(0);
        
        // Ingresos en una sola barra (Jun/Jul) con el total anual
        const ventas = new Array(12).fill(0);
        ventas[11] = ingresoAnual || 0; // Jul
        
        chartEvolutivo = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: meses,
            datasets: [
              {
                label: 'Costos Programados',
                data: costos,
                backgroundColor: '#ef4444',
                borderColor: '#dc2626',
                borderWidth: 1,
                yAxisID: 'y'
              },
              {
                label: 'Ventas Programadas',
                data: ventas,
                backgroundColor: '#22c55e',
                borderColor: '#16a34a',
                borderWidth: 1,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'S/. ' + value.toLocaleString('es-PE');
                  }
                }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: {
                  drawOnChartArea: false
                },
                ticks: {
                  callback: function(value) {
                    return 'S/. ' + value.toLocaleString('es-PE');
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': S/. ' + context.parsed.y.toLocaleString('es-PE', {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2
                    });
                  }
                }
              }
            }
          }
        });
      }

      function llenarSector(sectorId, fichaId, datos) {
        const sector = document.getElementById(sectorId);
        const contenido = sector.querySelector('.sector-contenido');
        
        contenido.innerHTML = datos.map(d => `
          <div class="dato-fila">
            <div class="dato-label">${d.label}</div>
            <div class="dato-valor ${d.clase || ''}">
              ${d.valor}
            </div>
          </div>
        `).join('');
      }

      function formatNumber(num) {
        return new Intl.NumberFormat('es-CO', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(num);
      }

      document.getElementById('hectareas').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          calcularFichaTecnica();
        }
      });

      // Event listener para los íconos informativos de costos
      document.addEventListener('click', function(e) {
        if (e.target.id === 'info-costos-btn') {
          const tooltip = document.getElementById('info-costos-tooltip');
          tooltip.classList.toggle('activo');
          e.stopPropagation();
        } else if (e.target.id === 'info-instalacion-btn') {
          const tooltip = document.getElementById('info-instalacion-tooltip');
          tooltip.classList.toggle('activo');
          e.stopPropagation();
        } else if (e.target.closest('.info-tooltip')) {
          // No cerrar si se hace clic dentro del tooltip
          e.stopPropagation();
        } else {
          // Cerrar los tooltips si se hace clic fuera
          const tooltipCostos = document.getElementById('info-costos-tooltip');
          if (tooltipCostos) tooltipCostos.classList.remove('activo');
          const tooltipInst = document.getElementById('info-instalacion-tooltip');
          if (tooltipInst) tooltipInst.classList.remove('activo');
        }
      });
    </script>
  </body>
</html>